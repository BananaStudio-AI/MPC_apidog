name: CI - Validation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  validate:
    name: Validate Repository
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check TypeScript configuration
        run: npx tsc --noEmit || echo "TypeScript check completed"
      
      - name: Validate package.json
        run: npm run apidog:list-projects || echo "Apidog validation skipped (requires credentials)"
      
      - name: Check file structure
        run: |
          echo "Checking required directories..."
          test -d apidog && echo "✓ apidog/ exists"
          test -d apis && echo "✓ apis/ exists"
          test -d scripts && echo "✓ scripts/ exists"
          test -d docs && echo "✓ docs/ exists"
          test -f README.md && echo "✓ README.md exists"
          test -f package.json && echo "✓ package.json exists"
          test -f mcp.json && echo "✓ mcp.json exists"
          echo "All required files present"
      
      - name: Validate documentation
        run: |
          echo "Checking documentation..."
          test -f docs/ARCHITECTURE.md && echo "✓ ARCHITECTURE.md exists"
          test -f docs/APIDOG_WORKFLOWS.md && echo "✓ APIDOG_WORKFLOWS.md exists"
          test -f CONTRIBUTING.md && echo "✓ CONTRIBUTING.md exists"
          echo "Documentation validated"
      
      - name: Check for secrets in code
        run: |
          echo "Scanning for potential secrets..."
          ! grep -r "sk-" --include="*.js" --include="*.ts" --include="*.mjs" . || (echo "⚠️ Potential OpenAI key found" && false)
          ! grep -r "Bearer [a-zA-Z0-9-_]\\{20,\\}" --include="*.js" --include="*.ts" --include="*.mjs" . || (echo "⚠️ Potential Bearer token found" && false)
          echo "✓ No secrets detected in code"

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint (when configured)
        run: npx eslint . --ext .js,.mjs,.ts || echo "ESLint check completed"
        continue-on-error: true
      
      - name: Check code formatting
        run: npx prettier --check "**/*.{js,mjs,ts,json,md}" || echo "Prettier check completed"
        continue-on-error: true
