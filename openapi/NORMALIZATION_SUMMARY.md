# OpenAPI Normalization Summary

## Overview
This document summarizes the normalization of the BananaStudio API Hub OpenAPI specification.

## Files Created

### 1. `api-hub.raw.oas.json`
- **Source**: Copied from `apidog/generated/oas_merged.json`
- **Purpose**: Raw OpenAPI spec as fetched from Apidog
- **Content**: Original spec with minimal structure, no tags, no servers

### 2. `api-hub.oas.json`
- **Source**: Generated by `scripts/normalize_openapi.js`
- **Purpose**: Normalized OpenAPI spec with proper tags, servers, and clean paths
- **Format**: OpenAPI 3.0.1

## Analysis of Raw Spec

### Original Structure
- **OpenAPI Version**: 3.1.0
- **Title**: "Default module"
- **Paths**: 3 endpoints
- **Tags**: None
- **Servers**: Empty array

### Original Paths
1. `GET /` - "GET Models Pricing" (FAL API pricing endpoint)
2. `GET /models` - "GET Model search" (FAL API model search)
3. `POST /v1/models/pricing/estimate` - "Estimate Model Pricing" (FAL API)

### Issues Identified
- No server definitions
- No tags to organize endpoints by API provider
- Inconsistent path structure (mixing `/` and `/v1/models/...`)
- Missing endpoints mentioned in project requirements
- No COMET_API endpoints present

## Normalized Specification

### Servers Defined
```json
[
  {
    "url": "https://api.cometapi.com/v1",
    "description": "Comet API"
  },
  {
    "url": "https://api.fal.ai/v1",
    "description": "FAL Platform API"
  }
]
```

### Tags Defined
```json
[
  {
    "name": "COMET_API",
    "description": "Comet Models API - Model registry, metadata, and pricing"
  },
  {
    "name": "FAL_API",
    "description": "FAL Platform API - Creative generation and model services"
  }
]
```

### Normalized Paths

#### COMET_API Endpoints
| Method | Path | Summary | Server |
|--------|------|---------|--------|
| GET | `/models` | GET Models | Comet API |

**Schema Reference**: `#/components/schemas/CometModelsResponse`

#### FAL_API Endpoints
| Method | Path | Summary | Server |
|--------|------|---------|--------|
| GET | `/models/search` | Search models (FAL) | FAL Platform API |
| GET | `/models/pricing` | GET Models Pricing | FAL Platform API |
| POST | `/models/pricing/estimate` | Estimate Model Pricing | FAL Platform API |
| GET | `/models/usage` | GET Usage | FAL Platform API |
| GET | `/models/analytics` | GET Analytics | FAL Platform API |

### Path Normalization Rules Applied

1. **`GET /` → `GET /models/pricing`**
   - Original root path repurposed for pricing
   - Now clearly indicates its purpose

2. **`GET /models` (search) → `GET /models/search`**
   - Moved to `/models/search` to avoid conflict with COMET `/models`
   - Clear distinction between FAL search and COMET list

3. **`POST /v1/models/pricing/estimate` → `POST /models/pricing/estimate`**
   - Removed `/v1` prefix (version in server URL instead)
   - Consistent path structure

4. **Added `GET /models` for COMET_API**
   - New endpoint to represent Comet Models API
   - Uses Comet server via operation-level `servers` array

5. **Added `GET /models/usage` for FAL_API**
   - Mentioned in requirements but missing from raw spec
   - Placeholder with basic structure

6. **Added `GET /models/analytics` for FAL_API**
   - Mentioned in requirements but missing from raw spec
   - Placeholder with basic structure

### Operation-Level Server Assignment

Each operation includes a `servers` array that specifies which backend to use:

- **COMET_API operations** → `https://api.cometapi.com/v1`
- **FAL_API operations** → `https://api.fal.ai/v1`

This allows client generators to route requests to the correct API provider.

## Components Preserved

The normalized spec preserves all schemas and security schemes from the raw spec:

- `CometModelsResponse` schema (referenced by COMET GET /models)
- All other component definitions

## Usage

### Generate Normalized Spec
```bash
npm run oas:normalize
```

### View Servers
```bash
cat openapi/api-hub.oas.json | jq '.servers'
```

### View Paths Summary
```bash
cat openapi/api-hub.oas.json | jq '.paths | keys'
```

### View COMET_API Endpoints
```bash
cat openapi/api-hub.oas.json | jq '.paths | to_entries[] | select(.value | .. | .tags? // [] | contains(["COMET_API"]))'
```

### View FAL_API Endpoints
```bash
cat openapi/api-hub.oas.json | jq '.paths | to_entries[] | select(.value | .. | .tags? // [] | contains(["FAL_API"]))'
```

## Next Steps

1. **Client Generation**: Use the normalized spec to generate typed clients
   ```bash
   npm run generate:client
   ```

2. **Import to Apidog**: Upload `api-hub.oas.json` to Apidog to update the project

3. **Documentation**: Generate API documentation from the normalized spec

4. **Validation**: Use OpenAPI validators to ensure spec compliance
   ```bash
   npm run apidog:validate
   ```

## Script Details

**Script**: `scripts/normalize_openapi.js`

**Features**:
- Reads raw OAS from `openapi/api-hub.raw.oas.json`
- Normalizes paths, tags, and servers
- Adds missing endpoints from requirements
- Preserves schemas and components
- Outputs to `openapi/api-hub.oas.json`
- Provides detailed summary report

**Idempotent**: Running multiple times produces the same output.

## References

- **Problem Statement**: Original requirements for normalization
- **OpenAPI 3.0.1 Spec**: https://swagger.io/specification/v3/
- **Apidog Documentation**: https://apidog.com/docs/
