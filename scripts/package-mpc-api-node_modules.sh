#!/usr/bin/env bash
set -euo pipefail
timestamp="$(date +%Y%m%d%H%M%S)"
repo_root="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$repo_root/mpc-api"
echo "== Packaging mpc-api on networked machine =="
echo "Checking package-lock.json status..."
# Optional check that working tree is clean for mpc-api
git rev-parse --is-inside-work-tree >/dev/null 2>&1 || true
echo "Running npm ci to produce deterministic node_modules..."
# Prefer offline if cache exists; otherwise perform normal ci
npm ci --prefer-offline --no-audit --no-fund --loglevel=info
tarball="/tmp/mpc-api-node_modules-${timestamp}.tgz"
echo "Creating tarball $tarball ..."
tar -czf "$tarball" node_modules package-lock.json
if command -v sha256sum >/dev/null 2>&1; then
  sha256sum "$tarball"
else
  echo "sha256sum not found; skipping checksum."
fi
echo "Packaging complete. Copy $tarball to the offline machine (scp / usb / file share)."
