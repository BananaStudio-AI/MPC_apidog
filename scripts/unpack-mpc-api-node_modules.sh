#!/usr/bin/env bash
set -euo pipefail
if [ "$#" -ne 1 ]; then
  echo "Usage: $0 /path/to/mpc-api-node_modules-<timestamp>.tgz"
  exit 2
fi
tarball="$1"
repo_root="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
if [ ! -f "$tarball" ]; then
  echo "Tarball not found: $tarball"
  exit 3
fi
echo "== Unpacking tarball into $repo_root/mpc-api =="
# validate tarball
tar -tzf "$tarball" >/dev/null || { echo "Invalid tarball"; exit 4; }
# Extract into mpc-api
tar -xzf "$tarball" -C "$repo_root/mpc-api"
echo "Extraction complete. Listing node_modules:"
ls -ld "$repo_root/mpc-api/node_modules" || true
cd "$repo_root/mpc-api"
echo "Running npm test (first 200 lines)..."
npm test 2>&1 | sed -n '1,200p' || true
echo "If tests rely on environment variables or services, set those before running."
